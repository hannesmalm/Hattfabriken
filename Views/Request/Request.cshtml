@using System.Security.Claims
@model Request

<div class="container">
    <a asp-controller="Request" asp-action="AllRequests" class="btn btn-primary mb-3">Back to list</a>

    @if (Model == null)
    {
        <p class="alert alert-warning">Förfrågan hittades inte.</p>
    }
    else
    {
        <h4 class="mb-4">FÖRFRÅGAN</h4>

        <div class="row">
            <div class="col-md-6">
                <p>ID: @Model.Id</p>
                <p>Name: @Model.Name</p>
                <p>Address: @Model.Adress</p>
                <p>Postal Code: @Model.PostalCode</p>
                <p>Country: @Model.Country</p>
                <p>Email: @Model.Email</p>
                <p>Phone Number: @Model.PhoneNumber</p>
                <p>Client's Message: @Model.Commentary</p>
            </div>
            <div class="col-md-6">
                @if (Model.RequestImage != null)
                {
                    var imageBase64 = Convert.ToBase64String(Model.RequestImage);
                    var imageSrc = $"data:image/png;base64,{imageBase64}";
                    <img class="img-fluid rounded" src="@imageSrc" alt="Request Image">
                }
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-6">
                <p>Hat-ID: @Model.HatId</p>
                <p>Material: @Model.Material</p>
                <p>Measurement: @Model.Measurement</p>
                <p>Height: @Model.Height</p>
                <p>Special Effects:</p>
                <ul>
                    @foreach (var specialEffect in Model.SpecialEffects)
                    {
                        <li>@specialEffect</li>
                    }
                </ul>
            </div>

            <div class="col-md-6">
                <h4>Status:</h4>
                <p>@Model.Status</p>
                @if (Model.Status == "Pending")
                {
                    <form id="acceptForm">
                        <input type="hidden" name="requestId" value="@Model.Id" />
                        <input type="hidden" name="customerEmail" value="@Model.Email" />
                        <input type="hidden" name="customerName" value="@Model.Name" />
                        <button type="button" onclick="acceptRequest()" class="btn btn-success w-100">Accept Request</button>
                    </form>
                    <form id="declineForm">
                        <input type="hidden" name="requestId" value="@Model.Id" />
                        <input type="hidden" name="customerEmail" value="@Model.Email" />
                        <input type="hidden" name="customerName" value="@Model.Name" />
                        <button type="button" onclick="declineRequest()" class="btn btn-danger w-100">Decline Request</button>
                    </form>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function acceptRequest() {
            var form = document.getElementById('acceptForm');
            var customerEmail = form.querySelector('[name="customerEmail"]').value;
            var customerName = form.querySelector('[name="customerName"]').value;
            var requestId = form.querySelector('[name="requestId"]').value;

            redirectToSendEmail(customerEmail, customerName, requestId, "Request Accepted");
        }

        function declineRequest() {
            var form = document.getElementById('declineForm');
            var customerEmail = form.querySelector('[name="customerEmail"]').value;
            var customerName = form.querySelector('[name="customerName"]').value;
            var requestId = form.querySelector('[name="requestId"]').value;

            redirectToSendEmail(customerEmail, customerName, requestId, "Request Declined");
        }

        function redirectToSendEmail(customerEmail, customerName, requestId, subject) {
            var emailData = {
                EmailToID: customerEmail,
                EmailToName: customerName,
                EmailSubject: subject,
                EmailBody: "Dear " + customerName + ",\n\nYour request with Request-ID " + requestId + (subject === "Request Accepted" ? " has been accepted." : " has been declined.") + "\n\nBest regards,\nThe Hat Factory Team"
            };

            var url = '/Email/SendAnEmail?' +
                'EmailToID=' + encodeURIComponent(emailData.EmailToID) +
                '&EmailToName=' + encodeURIComponent(emailData.EmailToName) +
                '&EmailSubject=' + encodeURIComponent(emailData.EmailSubject) +
                '&EmailBody=' + encodeURIComponent(emailData.EmailBody);

            window.location.href = url;
        }
    </script>
}
